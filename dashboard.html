<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantasy Pet League - Dashboard</title>
  <link rel="stylesheet" href="/frontend/css/style.css">
  <style>
    .welcome-banner {
      background: linear-gradient(135deg, #3498db, #9b59b6);
      color: white;
      padding: 40px 24px;
      border-radius: 8px;
      margin-bottom: 30px;
      box-shadow: 0 4px 16px rgba(52, 152, 219, 0.3);
    }
    .welcome-banner-content {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 20px;
    }
    .welcome-banner h1 {
      font-size: 32px;
      margin: 0 0 8px 0;
    }
    .welcome-banner p {
      margin: 0;
      opacity: 0.9;
      font-size: 16px;
    }
    .welcome-banner .btn {
      height: fit-content;
      white-space: nowrap;
    }
    .league-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 4px;
      margin-bottom: 8px;
    }
    .league-name {
      font-weight: 600;
      flex: 1;
    }

    /* Debug Panel */
    .debug-panel {
      background: #f0f0f0;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 12px;
      margin-top: 30px;
      font-size: 11px;
      font-family: monospace;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .debug-panel h4 {
      margin: 0 0 8px 0;
      font-size: 12px;
      color: #333;
    }
    
    .debug-log {
      background: white;
      border: 1px solid #ddd;
      border-radius: 3px;
      padding: 8px;
      line-height: 1.3;
      color: #333;
    }
    
    .debug-log-entry {
      margin-bottom: 3px;
      padding: 2px 4px;
      border-radius: 2px;
    }
    
    .debug-log-entry.info {
      background: #d6eaf8;
      color: #1e3a8a;
    }
    
    .debug-log-entry.error {
      background: #fed7d7;
      color: #742a2a;
    }
    
    .debug-log-entry.success {
      background: #c6f6d5;
      color: #22543d;
    }

    .debug-log-entry.warning {
      background: #feebc8;
      color: #7c2d12;
    }
    
    .debug-toggle {
      margin-top: 8px;
      padding: 6px 12px;
      font-size: 11px;
      background: #666;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    
    .debug-toggle:hover {
      background: #444;
    }

    .loader-text {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }

    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ecf0f1;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Edit Name Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background-color: white;
      padding: 32px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      margin: 0;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .modal-close:hover {
      color: #000;
    }
  </style>
</head>
<body data-page="dashboard">
  <header>
    <div class="logo">üêæ Fantasy Pet League</div>
    <nav>
      <a href="#" onclick="app.handleLogout(); return false;">Logout</a>
    </nav>
  </header>

  <div class="container">
    <!-- Welcome Banner with Edit Name -->
    <div class="welcome-banner">
      <div class="welcome-banner-content">
        <div>
          <h1>Welcome, <span id="user-name">Loading...</span>! üéâ</h1>
          <p>Join leagues, draft pets, and compete on leaderboards</p>
        </div>
        <button class="btn btn-outline" style="color: white; border-color: white;" onclick="showEditNameModal()">Edit Name</button>
      </div>
    </div>

    <!-- Your Leagues -->
    <div class="card">
      <div class="card-header">
        <h2>Your Leagues</h2>
      </div>
      <div class="card-body">
        <div id="your-leagues-list">
          <div class="loader-text">
            <div class="loader"></div>
            <p>Loading your leagues...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Available Leagues -->
    <div class="card">
      <div class="card-header">
        <h2>Available Leagues to Join</h2>
      </div>
      <div class="card-body">
        <div id="available-leagues-list">
          <div class="loader-text">
            <div class="loader"></div>
            <p>Loading available leagues...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Create League Card -->
    <div class="card">
      <div class="card-header">
        <h2>Create a New League</h2>
      </div>
      <div class="card-body">
        <form onsubmit="app.createLeague(event)">
          <div class="form-group">
            <label for="leagueName">League Name</label>
            <input 
              type="text" 
              id="leagueName" 
              name="leagueName" 
              placeholder="e.g., Downtown Doggos" 
              required
            >
          </div>
          <button type="submit" class="btn btn-primary">Create League</button>
        </form>
      </div>
    </div>

    <!-- All Pets -->
    <div class="card">
      <div class="card-header">
        <h2>All Pets</h2>
      </div>
      <div class="card-body">
        <div id="all-pets-list">
          <div class="loader-text">
            <div class="loader"></div>
            <p>Loading pets...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Debug Panel -->
    <div class="debug-panel">
      <h4>üîç Debug Console</h4>
      <div class="debug-log" id="debug-log"></div>
      <button class="debug-toggle" onclick="clearDebugLog()">Clear Log</button>
      <button class="debug-toggle" onclick="downloadDebugLog()">Download Log</button>
    </div>
  </div>

  <!-- Edit Name Modal -->
  <div id="edit-name-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Your Name</h2>
        <button class="modal-close" onclick="closeEditNameModal()">√ó</button>
      </div>
      <form onsubmit="handleNameChange(event)">
        <div class="form-group">
          <label for="edit-name-input">Display Name</label>
          <input 
            type="text" 
            id="edit-name-input" 
            required
            placeholder="Enter your new name"
          >
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <button type="button" class="btn btn-outline" onclick="closeEditNameModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Name</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Load app.js FIRST -->
  <script src="/frontend/js/app.js"></script>
  
  <!-- Then our dashboard-specific code -->
  <script>
    // ===== Debug System =====

    const debugLogs = [];
    const MAX_LOGS = 60;

    function logDebug(type, message, data = null) {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = { type, message, data, timestamp };
      debugLogs.push(logEntry);
      
      if (debugLogs.length > MAX_LOGS) {
        debugLogs.shift();
      }

      console.log(`[${type.toUpperCase()}] ${message}`, data || '');
      updateDebugUI();
    }

    function updateDebugUI() {
      const debugLog = document.getElementById('debug-log');
      if (!debugLog) return;
      
      debugLog.innerHTML = debugLogs.map(entry => {
        let emoji = 'üìù';
        if (entry.type === 'error') emoji = '‚ùå';
        else if (entry.type === 'success') emoji = '‚úÖ';
        else if (entry.type === 'warning') emoji = '‚ö†Ô∏è';

        let dataStr = '';
        if (entry.data) {
          const dataJson = typeof entry.data === 'string' 
            ? entry.data 
            : JSON.stringify(entry.data);
          dataStr = `<br><small>‚Üí ${dataJson.slice(0, 120)}${dataJson.length > 120 ? '...' : ''}</small>`;
        }

        return `<div class="debug-log-entry ${entry.type}">
          ${emoji} [${entry.timestamp}] ${entry.message}${dataStr}
        </div>`;
      }).join('');

      debugLog.scrollTop = debugLog.scrollHeight;
    }

    function clearDebugLog() {
      debugLogs.length = 0;
      updateDebugUI();
      logDebug('info', 'Debug log cleared');
    }

    function downloadDebugLog() {
      const text = debugLogs.map(entry => 
        `[${entry.timestamp}] [${entry.type.toUpperCase()}] ${entry.message}` + 
        (entry.data ? ` ‚Üí ${JSON.stringify(entry.data)}` : '')
      ).join('\n');

      const blob = new Blob([text], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `debug-${new Date().toISOString().slice(0, 10)}.txt`;
      a.click();
      window.URL.revokeObjectURL(url);

      logDebug('success', 'Debug log downloaded');
    }

    // ===== Edit Name Modal =====

    function showEditNameModal() {
      const user = JSON.parse(localStorage.getItem('user_data') || '{}');
      document.getElementById('edit-name-input').value = user.first_name || '';
      document.getElementById('edit-name-modal').classList.add('active');
    }

    function closeEditNameModal() {
      document.getElementById('edit-name-modal').classList.remove('active');
    }

    async function handleNameChange(event) {
      event.preventDefault();
      const newName = document.getElementById('edit-name-input').value.trim();

      if (!newName) {
        window.showAlert('Please enter a name', 'warning');
        return;
      }

      try {
        logDebug('info', `Updating name to: ${newName}`);

        // Call API to update name
        const response = await window.apiCall('/api/auth/update-name', {
          method: 'POST',
          body: JSON.stringify({ firstName: newName })
        });

        if (response) {
          // Update local storage
          const user = JSON.parse(localStorage.getItem('user_data') || '{}');
          user.first_name = newName;
          localStorage.setItem('user_data', JSON.stringify(user));

          // Update display
          document.getElementById('user-name').textContent = newName;

          logDebug('success', `Name updated to: ${newName}`);
          window.showAlert('Name updated successfully!', 'success');
          closeEditNameModal();
        }
      } catch (error) {
        logDebug('error', `Failed to update name: ${error.message}`);
        window.showAlert(`Error: ${error.message}`, 'danger');
      }
    }

    // ===== Page Initialization (FIXED) =====

    function initDashboard() {
      logDebug('info', 'üìä Dashboard loading...');
      
      const token = localStorage.getItem('auth_token');
      if (!token) {
        logDebug('error', 'No auth token found');
        window.location.href = '/index.html?login=required';
        return;
      }

      logDebug('success', 'Auth token verified');

      const user = JSON.parse(localStorage.getItem('user_data') || '{}');
      logDebug('info', `User loaded: ${user.first_name}`);

      const userNameEl = document.getElementById('user-name');
      if (userNameEl) {
        userNameEl.textContent = user.first_name || 'Player';
      }

      // Load data with logging
      logDebug('info', 'Fetching Your Leagues...');
      app.loadUserLeagues();

      logDebug('info', 'Fetching Available Leagues...');
      app.loadAvailableLeagues();

      logDebug('info', 'Fetching All Pets...');
      app.loadAllPets();
    }

    // Wait for app to be initialized before loading dashboard data
    function waitForApp() {
      if (window.app && typeof window.app.loadUserLeagues === 'function') {
        initDashboard();
      } else {
        setTimeout(waitForApp, 100);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      waitForApp();
    });
  </script>
</body>
</html>