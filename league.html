<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantasy Pet League - League</title>
  <link rel="stylesheet" href="/frontend/css/style.css">
  <style>
    .league-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .roster-player {
      background: #f9f9f9;
      padding: 16px;
      border-radius: 6px;
      margin-bottom: 16px;
      border-left: 4px solid #3498db;
    }

    .roster-player-name {
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
      margin-bottom: 12px;
    }

    .roster-size-info {
      display: inline-block;
      background: #e8f4f8;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: #2980b9;
      font-weight: 600;
      margin-left: 8px;
    }

    .roster-size-info.full {
      background: #fed7d7;
      color: #742a2a;
    }

    .roster-pet {
      background: white;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 10px;
      border: 1px solid #ecf0f1;
    }

    .roster-pet-name {
      font-weight: 600;
      color: #3498db;
      margin-bottom: 8px;
    }

    .roster-pet-stats {
      font-size: 13px;
      color: #555;
      line-height: 1.6;
    }

    .roster-pet-stat {
      display: inline-block;
      margin-right: 12px;
      padding-right: 12px;
      border-right: 1px solid #ecf0f1;
    }

    .roster-pet-stat:last-child {
      border-right: none;
    }

    .leaderboard-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: #f9f9f9;
      border-radius: 4px;
      margin-bottom: 8px;
    }

    .leaderboard-rank {
      font-weight: 600;
      min-width: 40px;
    }

    .leaderboard-info {
      flex: 1;
      margin: 0 12px;
    }

    .leaderboard-name {
      font-weight: 600;
    }

    .leaderboard-city {
      font-size: 12px;
      color: #7f8c8d;
    }

    .leaderboard-points {
      font-weight: 600;
      color: #9b59b6;
    }

    .pet-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }

    .pet-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: #3498db;
    }

    .pet-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .pet-card-header h3 {
      margin: 0;
      font-size: 16px;
      color: #2c3e50;
    }

    .pet-card-breed {
      font-size: 12px;
      color: #7f8c8d;
      margin-bottom: 8px;
    }

    .pet-card-stats {
      font-size: 13px;
      line-height: 1.6;
      color: #555;
    }

    .pet-stat {
      display: inline-block;
      margin-right: 12px;
      padding-right: 12px;
      border-right: 1px solid #ecf0f1;
    }

    .pet-stat:last-child {
      border-right: none;
    }

    .loader-text {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }

    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ecf0f1;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Roster limit alert */
    .roster-limit-alert {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 4px;
      padding: 12px;
      margin-bottom: 16px;
      color: #856404;
      font-size: 14px;
      display: none;
    }

    .roster-limit-alert.show {
      display: block;
    }

    .roster-limit-progress {
      background: #ecf0f1;
      border-radius: 4px;
      height: 6px;
      margin-top: 8px;
      overflow: hidden;
    }

    .roster-limit-progress-bar {
      height: 100%;
      background: #3498db;
      transition: all 0.3s ease;
    }

    .roster-limit-progress-bar.warning {
      background: #f39c12;
    }

    .roster-limit-progress-bar.full {
      background: #e74c3c;
    }

    @media (max-width: 1024px) {
      .league-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body data-page="league">
  <header>
    <div class="logo">üêæ Fantasy Pet League</div>
    <nav>
      <a href="/dashboard.html">Dashboard</a>
      <a href="#" onclick="app.handleLogout(); return false;">Logout</a>
    </nav>
  </header>

  <div class="container">
    <div class="league-container">
      <!-- Left Sidebar -->
      <div class="league-left">
        <!-- Leaderboard -->
        <div class="card">
          <div class="card-header">
            <h2>Leaderboard</h2>
          </div>
          <div class="card-body">
            <div id="leaderboard-list">
              <div class="loader-text">
                <div class="loader"></div>
                <p>Loading leaderboard...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- All Rosters -->
        <div class="card">
          <div class="card-header">
            <h2>All Rosters</h2>
          </div>
          <div class="card-body">
            <div id="rosters-list">
              <div class="loader-text">
                <div class="loader"></div>
                <p>Loading rosters...</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side - Available Pets -->
      <div class="league-right">
        <!-- Roster limit info (shown when near limit) -->
        <div class="roster-limit-alert" id="roster-limit-alert">
          <strong>üìã Roster Limit Alert</strong>
          <p id="roster-limit-message" style="margin: 4px 0 0 0;"></p>
          <div class="roster-limit-progress">
            <div class="roster-limit-progress-bar" id="roster-limit-bar"></div>
          </div>
        </div>

        <!-- Filter Section -->
        <div class="card" style="margin-bottom: 20px;">
          <div class="card-header">
            <h2>Filter & Sort Pets</h2>
          </div>
          <div class="card-body">
            <!-- Row 1: Animal Type & Gender -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div class="form-group">
                <label for="filter-animal-type">Animal Type</label>
                <select id="filter-animal-type" onchange="updatePetFilters()">
                  <option value="">All Animals</option>
                  <option value="Dog">Dogs</option>
                  <option value="Cat">Cats</option>
                </select>
              </div>

              <div class="form-group">
                <label for="filter-gender">Gender</label>
                <select id="filter-gender" onchange="updatePetFilters()">
                  <option value="">All Genders</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Spayed Female">Spayed Female</option>
                  <option value="Neutered Male">Neutered Male</option>
                </select>
              </div>
            </div>

            <!-- Row 2: Age Group & Breed -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
              <div class="form-group">
                <label for="filter-age-group">Age Group</label>
                <select id="filter-age-group" onchange="updatePetFilters()">
                  <option value="">All Ages</option>
                  <option value="puppy">Puppy/Kitten (&lt;1y)</option>
                  <option value="young">Young (1-3y)</option>
                  <option value="adult">Adult (3-7y)</option>
                  <option value="senior">Senior (7y+)</option>
                </select>
              </div>

              <div class="form-group">
                <label for="filter-breed">Breed</label>
                <select id="filter-breed" onchange="updatePetFilters()">
                  <option value="">All Breeds</option>
                </select>
              </div>
            </div>

            <!-- Row 3: Days in Shelter Range Slider -->
            <div style="margin-bottom: 16px;">
              <label style="font-weight: 600;">Days in Shelter: <span id="days-range-display" style="color: #3498db;">0 - 365</span> days</label>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 12px;">
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <label for="filter-days-min" style="font-size: 12px; font-weight: 600;">Min</label>
                    <small id="days-min-value" style="color: #7f8c8d;">0 days</small>
                  </div>
                  <input 
                    type="range" 
                    id="filter-days-min" 
                    min="0" 
                    max="365" 
                    value="0"
                    onchange="updatePetFilters()"
                    style="width: 100%; cursor: pointer;"
                  >
                </div>
                <div>
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <label for="filter-days-max" style="font-size: 12px; font-weight: 600;">Max</label>
                    <small id="days-max-value" style="color: #7f8c8d;">365 days</small>
                  </div>
                  <input 
                    type="range" 
                    id="filter-days-max" 
                    min="0" 
                    max="365" 
                    value="365"
                    onchange="updatePetFilters()"
                    style="width: 100%; cursor: pointer;"
                  >
                </div>
              </div>
            </div>

            <!-- Row 4: Sort & Reset -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
              <div class="form-group">
                <label for="filter-sort">Sort By</label>
                <select id="filter-sort" onchange="updatePetFilters()">
                  <option value="name-az">Name A-Z</option>
                  <option value="days-old">Days in Shelter (Oldest First)</option>
                  <option value="days-new">Days in Shelter (Newest First)</option>
                  <option value="age-old">Age (Oldest First)</option>
                  <option value="age-new">Age (Youngest First)</option>
                </select>
              </div>
              <div style="display: flex; align-items: flex-end;">
                <button class="btn btn-outline" onclick="resetPetFilters()" style="width: 100%; cursor: pointer;">üîÑ Clear All Filters</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Available Pets Card -->
        <div class="card">
          <div class="card-header">
            <h2>Available Pets to Draft</h2>
          </div>
          <div class="card-body">
            <div id="pets-list">
              <div class="loader-text">
                <div class="loader"></div>
                <p>Loading pets...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/frontend/js/app.js"></script>
  <script>
    let currentLeagueId = null;
    let leagueCurrentPage = 1;
    let currentUserRosterSize = 0;
    let rosterLimit = 10; // Default, will be updated from API

    function initLeague() {
      currentLeagueId = new URLSearchParams(window.location.search).get('id');
      if (!currentLeagueId) {
        window.location.href = '/dashboard.html';
        return;
      }

      console.log('[LEAGUE] Loading league view:', currentLeagueId);
      
      app.loadLeaderboard(currentLeagueId);
      app.loadLeagueRosters(currentLeagueId);
      app.loadLeagueAvailablePets(currentLeagueId);
      updateRosterLimitDisplay();
    }

    // Update roster limit display
    function updateRosterLimitDisplay() {
      const userId = JSON.parse(localStorage.getItem('user_data') || '{}').id;
      
      window.apiCall(`/api/drafting/${currentLeagueId}`, {
        method: 'GET'
      }).then(data => {
        if (data) {
          currentUserRosterSize = data.current_size || 0;
          rosterLimit = data.limit || 10;
          
          const alertBox = document.getElementById('roster-limit-alert');
          const message = document.getElementById('roster-limit-message');
          const progressBar = document.getElementById('roster-limit-bar');
          
          const percentage = (currentUserRosterSize / rosterLimit) * 100;
          
          // Update progress bar
          progressBar.style.width = percentage + '%';
          progressBar.classList.remove('warning', 'full');
          
          if (percentage >= 100) {
            progressBar.classList.add('full');
            message.textContent = `Your roster is FULL! (${currentUserRosterSize}/${rosterLimit} pets)`;
            alertBox.classList.add('show');
          } else if (percentage >= 75) {
            progressBar.classList.add('warning');
            message.textContent = `Your roster is getting full! (${currentUserRosterSize}/${rosterLimit} pets, ${rosterLimit - currentUserRosterSize} slots remaining)`;
            alertBox.classList.add('show');
          } else {
            alertBox.classList.remove('show');
          }
          
          console.log('[ROSTER_LIMIT] User has', currentUserRosterSize, '/', rosterLimit, 'pets');
        }
      }).catch(err => {
        console.error('[ROSTER_LIMIT] Error:', err);
      });
    }

    // Wait for app to be initialized before loading league data
    function waitForApp() {
      if (window.app && typeof window.app.loadLeaderboard === 'function') {
        initLeague();
      } else {
        setTimeout(waitForApp, 100);
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      waitForApp();
      // Update roster limit display every 3 seconds
      setInterval(updateRosterLimitDisplay, 3000);
    });

    window.draftPetLeague = async function(petId, leagueId) {
      const savedPage = leagueCurrentPage;
      console.log('[LEAGUE-DRAFT] Saving page:', savedPage);
      
      try {
        if (window.app && window.app.draftPet) {
          await window.app.draftPet(petId, leagueId);
          
          setTimeout(() => {
            console.log('[LEAGUE-DRAFT] Restoring page:', savedPage);
            updateRosterLimitDisplay();
            app.loadLeagueRosters(leagueId);
            leagueCurrentPage = savedPage;
            app.loadLeagueAvailablePets(leagueId);
          }, 800);
        }
      } catch (error) {
        console.error('[LEAGUE-DRAFT] Error:', error);
      }
    };

    window.goToLeaguePagePreserve = function(pageNum) {
      console.log('[LEAGUE-PAGE] Navigating to page:', pageNum);
      leagueCurrentPage = pageNum;
      if (typeof window.goToLeaguePagePreserveOriginal === 'function') {
        window.goToLeaguePagePreserveOriginal(pageNum);
      }
    };
  </script>
</body>
</html>