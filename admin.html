<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fantasy Pet League - Admin Dashboard</title>
  <link rel="stylesheet" href="/frontend/css/style.css">
  <style>
    .admin-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .admin-section {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .admin-section h2 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 2px solid #3498db;
      padding-bottom: 12px;
    }

    .admin-item {
      background: #f9f9f9;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .admin-item-info {
      flex: 1;
    }

    .admin-item-name {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 4px;
    }

    .admin-item-meta {
      font-size: 12px;
      color: #7f8c8d;
    }

    .admin-item-actions {
      display: flex;
      gap: 8px;
    }

    .btn-danger-small {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-danger-small:hover {
      background: #c0392b;
      transform: scale(1.05);
    }

    .search-box {
      width: 100%;
      padding: 10px;
      margin-bottom: 16px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-size: 14px;
    }

    .search-box::placeholder {
      color: #95a5a6;
    }

    .loader-text {
      text-align: center;
      padding: 20px;
      color: #7f8c8d;
    }

    .loader {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #ecf0f1;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .stat-box {
      background: linear-gradient(135deg, #3498db, #9b59b6);
      color: white;
      padding: 16px;
      border-radius: 6px;
      text-align: center;
    }

    .stat-number {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      opacity: 0.9;
    }

    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      color: #856404;
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 16px;
      font-size: 13px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 8px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 12px;
      color: #2c3e50;
    }

    .modal-body {
      color: #555;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn-cancel {
      background: #95a5a6;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-cancel:hover {
      background: #7f8c8d;
    }

    .btn-confirm-delete {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }

    .btn-confirm-delete:hover {
      background: #c0392b;
    }

    @media (max-width: 1024px) {
      .admin-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body data-page="admin">
  <header>
    <div class="logo">üêæ Fantasy Pet League - Admin</div>
    <nav>
      <a href="/dashboard.html">Dashboard</a>
      <a href="#" onclick="app.handleLogout(); return false;">Logout</a>
    </nav>
  </header>

  <div class="container">
    <div class="admin-container">
      <!-- Users Management -->
      <div class="admin-section">
        <h2>Users Management</h2>
        
        <div class="alert-warning">
          ‚ö†Ô∏è Deleting a user will remove all their data including rosters and drafted pets.
        </div>

        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-number" id="total-users">0</div>
            <div class="stat-label">Total Users</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="admin-count">0</div>
            <div class="stat-label">Admins</div>
          </div>
        </div>

        <input 
          type="text" 
          class="search-box" 
          id="user-search" 
          placeholder="Search by name..."
          onkeyup="app.filterUsers(this.value)"
        >

        <div id="users-list">
          <div class="loader-text">
            <div class="loader"></div>
            <p>Loading users...</p>
          </div>
        </div>
      </div>

      <!-- Leagues Management -->
      <div class="admin-section">
        <h2>Leagues Management</h2>
        
        <div class="alert-warning">
          ‚ö†Ô∏è Deleting a league will remove it and all associated rosters.
        </div>

        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-number" id="total-leagues">0</div>
            <div class="stat-label">Total Leagues</div>
          </div>
          <div class="stat-box">
            <div class="stat-number" id="total-leagues-members">0</div>
            <div class="stat-label">Total Players</div>
          </div>
        </div>

        <input 
          type="text" 
          class="search-box" 
          id="league-search" 
          placeholder="Search by name..."
          onkeyup="app.filterLeagues(this.value)"
        >

        <div id="leagues-list">
          <div class="loader-text">
            <div class="loader"></div>
            <p>Loading leagues...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="delete-modal">
    <div class="modal-content">
      <div class="modal-header">Confirm Delete</div>
      <div class="modal-body" id="modal-message">
        Are you sure you want to delete this?
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="app.closeDeleteModal()">Cancel</button>
        <button class="btn-confirm-delete" onclick="app.confirmDelete()">Delete</button>
      </div>
    </div>
  </div>

  <script src="/frontend/js/app.js"></script>
  <script>
    // ===== Admin-specific state =====
    let allUsers = [];
    let allLeagues = [];
    let deleteTarget = null;

    // ===== Admin Functions =====

    async function loadUsers() {
      try {
        console.log('[ADMIN] Loading users...');
        const users = await apiCall('/api/admin/users');
        
        if (!users) return;

        allUsers = users;
        document.getElementById('total-users').textContent = users.length;
        document.getElementById('admin-count').textContent = users.filter(u => u.is_admin).length;

        renderUsers(users);
      } catch (error) {
        console.error('[ADMIN] Error loading users:', error);
        document.getElementById('users-list').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
      }
    }

    function renderUsers(users) {
      const container = document.getElementById('users-list');
      
      if (users.length === 0) {
        container.innerHTML = '<p>No users found.</p>';
        return;
      }

      container.innerHTML = users.map(user => `
        <div class="admin-item">
          <div class="admin-item-info">
            <div class="admin-item-name">${user.first_name}</div>
            <div class="admin-item-meta">
              ${user.city ? `üìç ${user.city}` : ''} 
              ${user.is_admin ? 'üëë Admin' : ''}
            </div>
          </div>
          <div class="admin-item-actions">
            <button class="btn-danger-small" onclick="app.deleteUser(${user.id}, '${user.first_name}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    app.filterUsers = function(query) {
      const filtered = allUsers.filter(u => 
        u.first_name.toLowerCase().includes(query.toLowerCase()) ||
        (u.city && u.city.toLowerCase().includes(query.toLowerCase()))
      );
      renderUsers(filtered);
    };

    app.deleteUser = function(userId, userName) {
      deleteTarget = { type: 'user', id: userId, name: userName };
      document.getElementById('modal-message').innerHTML = `
        <strong>Delete User: ${userName}</strong><br><br>
        This will delete:<br>
        ‚Ä¢ User account<br>
        ‚Ä¢ All drafted pets<br>
        ‚Ä¢ All league memberships<br><br>
        This action cannot be undone.
      `;
      document.getElementById('delete-modal').classList.add('active');
    };

    // ===== Leagues =====

    async function loadLeagues() {
      try {
        console.log('[ADMIN] Loading leagues...');
        const leagues = await apiCall('/api/admin/leagues');
        
        if (!leagues) return;

        allLeagues = leagues;
        document.getElementById('total-leagues').textContent = leagues.length;

        // Calculate total members
        const totalMembers = leagues.reduce((sum, l) => sum + (l.member_count || 0), 0);
        document.getElementById('total-leagues-members').textContent = totalMembers;

        renderLeagues(leagues);
      } catch (error) {
        console.error('[ADMIN] Error loading leagues:', error);
        document.getElementById('leagues-list').innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
      }
    }

    function renderLeagues(leagues) {
      const container = document.getElementById('leagues-list');
      
      if (leagues.length === 0) {
        container.innerHTML = '<p>No leagues found.</p>';
        return;
      }

      container.innerHTML = leagues.map(league => `
        <div class="admin-item">
          <div class="admin-item-info">
            <div class="admin-item-name">${league.name}</div>
            <div class="admin-item-meta">üë• ${league.member_count || 0} players</div>
          </div>
          <div class="admin-item-actions">
            <button class="btn-danger-small" onclick="app.deleteLeague(${league.id}, '${league.name}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    app.filterLeagues = function(query) {
      const filtered = allLeagues.filter(l => 
        l.name.toLowerCase().includes(query.toLowerCase())
      );
      renderLeagues(filtered);
    };

    app.deleteLeague = function(leagueId, leagueName) {
      deleteTarget = { type: 'league', id: leagueId, name: leagueName };
      document.getElementById('modal-message').innerHTML = `
        <strong>Delete League: ${leagueName}</strong><br><br>
        This will delete:<br>
        ‚Ä¢ League<br>
        ‚Ä¢ All rosters<br>
        ‚Ä¢ All drafted pets in this league<br><br>
        This action cannot be undone.
      `;
      document.getElementById('delete-modal').classList.add('active');
    };

    // ===== Modal =====

    app.closeDeleteModal = function() {
      document.getElementById('delete-modal').classList.remove('active');
      deleteTarget = null;
    };

    app.confirmDelete = async function() {
      if (!deleteTarget) return;

      try {
        if (deleteTarget.type === 'user') {
          console.log('[ADMIN] Deleting user:', deleteTarget.id);
          await apiCall(`/api/admin/users/${deleteTarget.id}`, {
            method: 'DELETE'
          });
          console.log('[ADMIN] User deleted successfully');
          app.showAlert(`User "${deleteTarget.name}" deleted successfully`, 'success');
          app.closeDeleteModal();
          loadUsers();
        } else if (deleteTarget.type === 'league') {
          console.log('[ADMIN] Deleting league:', deleteTarget.id);
          await apiCall(`/api/admin/leagues/${deleteTarget.id}`, {
            method: 'DELETE'
          });
          console.log('[ADMIN] League deleted successfully');
          app.showAlert(`League "${deleteTarget.name}" deleted successfully`, 'success');
          app.closeDeleteModal();
          loadLeagues();
        }
      } catch (error) {
        console.error('[ADMIN] Delete error:', error);
        app.showAlert(`Error deleting: ${error.message}`, 'danger');
      }
    };

    // ===== Page Init =====

    document.addEventListener('DOMContentLoaded', () => {
      console.log('[ADMIN] Admin dashboard loading...');
      
      if (!app.checkAuth()) return;

      const user = getUser();
      if (!user?.is_admin) {
        console.error('[ADMIN] User is not admin');
        window.location.href = '/dashboard.html';
        return;
      }

      console.log('[ADMIN] Admin verified:', user.first_name);
      loadUsers();
      loadLeagues();
    });

    function getUser() {
      const user = localStorage.getItem('user_data');
      return user ? JSON.parse(user) : null;
    }
  </script>
</body>
</html>